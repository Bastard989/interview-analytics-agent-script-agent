# =============================================================================
# ОБЩЕЕ
# =============================================================================
APP_ENV=dev
SERVICE_NAME=api-gateway

API_HOST=0.0.0.0
API_PORT=8010
# CSV список origin'ов для CORS; в APP_ENV=prod нельзя оставлять '*'
CORS_ALLOWED_ORIGINS=*
# Если CORS_ALLOWED_ORIGINS=* — приложение принудительно выключит credentials
CORS_ALLOW_CREDENTIALS=true

# =============================================================================
# AUTH
# =============================================================================
# api_key|jwt|none
AUTH_MODE=api_key
# Если AUTH_MODE=api_key, перечисляй ключи через запятую: key1,key2,key3
API_KEYS=
# Альтернатива через файл (например docker secrets):
# API_KEYS_FILE=/run/secrets/api_keys
# Service-to-service ключи (в AUTH_MODE=jwt fallback работает только для service ключей)
SERVICE_API_KEYS=
# SERVICE_API_KEYS_FILE=/run/secrets/service_api_keys
# В APP_ENV=prod AUTH_MODE=none запрещён
# В APP_ENV=prod по умолчанию требуется AUTH_MODE=jwt (можно ослабить только осознанно)
AUTH_REQUIRE_JWT_IN_PROD=true
# В APP_ENV=prod fallback service API key в режиме jwt игнорируется (только Bearer JWT)
ALLOW_SERVICE_API_KEY_IN_JWT_MODE=true

# JWT/OIDC (production) — включай, когда готов интегрировать провайдера
OIDC_ISSUER_URL=
OIDC_JWKS_URL=
OIDC_AUDIENCE=
OIDC_ALGORITHMS=RS256
OIDC_DISCOVERY_TIMEOUT_SEC=5
JWT_CLOCK_SKEW_SEC=30
JWT_SERVICE_CLAIM_KEY=token_type
JWT_SERVICE_CLAIM_VALUES=service,client_credentials,m2m
JWT_SERVICE_ROLE_CLAIM=roles
JWT_SERVICE_ALLOWED_ROLES=service,admin
JWT_SERVICE_PERMISSION_CLAIM=scope
JWT_SERVICE_REQUIRED_SCOPES_ADMIN_READ=agent.admin.read,agent.admin
JWT_SERVICE_REQUIRED_SCOPES_ADMIN_WRITE=agent.admin.write,agent.admin
JWT_SERVICE_REQUIRED_SCOPES_WS_INTERNAL=agent.ws.internal,agent.admin

# Multi-tenant enforcement (JWT only)
TENANT_ENFORCEMENT_ENABLED=false
TENANT_CLAIM_KEY=tenant_id
TENANT_CONTEXT_KEY=tenant_id
# Персистентный security audit trail в БД (security_audit_events)
SECURITY_AUDIT_DB_ENABLED=true
# В APP_ENV=prod сервис завершится при readiness error
READINESS_FAIL_FAST_IN_PROD=true

# DEV ONLY: shared secret для локальной проверки JWT без OIDC
JWT_SHARED_SECRET=
# JWT_SHARED_SECRET_FILE=/run/secrets/jwt_shared_secret

# External secrets provider (Vault)
# SECRETS_PROVIDER=vault
# VAULT_ADDR=https://vault.example.com
# VAULT_TOKEN=
# VAULT_TOKEN_FILE=/run/secrets/vault_token
# VAULT_NAMESPACE=
# VAULT_KV_MOUNT=secret
# VAULT_SECRET_PATH=interview-agent
# VAULT_KV_VERSION=2
# VAULT_TIMEOUT_SEC=5
# VAULT_SKIP_VERIFY=false
# Пример маппинга: ENV_KEY=secret_field
# VAULT_FIELD_MAP=API_KEYS=api_keys,SERVICE_API_KEYS=service_api_keys,JWT_SHARED_SECRET=jwt_shared_secret,SBERJAZZ_API_TOKEN=sberjazz_api_token,SMTP_PASS=smtp_pass,OPENAI_API_KEY=openai_api_key

# =============================================================================
# DB / REDIS
# =============================================================================
POSTGRES_DSN=postgresql+psycopg://postgres:postgres@postgres:5432/agent
REDIS_URL=redis://redis:6379/0
# redis|inline (inline = без Redis воркеров, обработка в API процессе)
QUEUE_MODE=redis

# =============================================================================
# STORAGE (chunks/blob)
# =============================================================================
# local_fs|shared_fs
STORAGE_MODE=local_fs
# Базовый путь для local_fs
CHUNKS_DIR=./data/chunks
# Базовый путь для сохранения transcript/report артефактов
RECORDS_DIR=./recordings
# Для shared_fs можно указать отдельный shared mount path (например NFS)
STORAGE_SHARED_FS_DIR=
# В prod запрещает local_fs
STORAGE_REQUIRE_SHARED_IN_PROD=true

# =============================================================================
# =============================================================================

# =============================================================================
# PII / RETENTION
# =============================================================================
PII_MASKING=true
RETENTION_DAYS_AUDIO=14
RETENTION_DAYS_TEXT=90

# =============================================================================
# STT (Speech-to-Text) — РАСПОЗНАВАНИЕ РЕЧИ
# =============================================================================
# Провайдер распознавания речи:
# whisper_local|google|salutespeech
STT_PROVIDER=whisper_local

# --- Локальный Whisper (faster-whisper) ---
# Модель: tiny|base|small|medium|large-v3
WHISPER_MODEL_SIZE=small
# cpu|cuda (для презентации/теста обычно cpu)
WHISPER_DEVICE=cpu
# int8 (быстрее на CPU) / float16/float32 (тяжелее)
WHISPER_COMPUTE_TYPE=int8
# Язык: ru|en|auto
WHISPER_LANGUAGE=ru
# VAD фильтр (часто улучшает качество на шумных сегментах)
WHISPER_VAD_FILTER=true
# beam_size (1 быстрее, 3-5 точнее)
WHISPER_BEAM_SIZE=1

# =============================================================================
# MEETING CONNECTOR (SBERJAZZ TARGET)
# =============================================================================
# sberjazz|sberjazz_mock|none
MEETING_CONNECTOR_PROVIDER=sberjazz_mock
# Авто-join коннектора на POST /v1/meetings/start для mode=realtime (если не переопределено в запросе)
MEETING_AUTO_JOIN_ON_START=false
SBERJAZZ_API_BASE=
SBERJAZZ_API_TOKEN=
# SBERJAZZ_API_TOKEN_FILE=/run/secrets/sberjazz_token
SBERJAZZ_FORCE_IPV4=false
SBERJAZZ_TIMEOUT_SEC=10
SBERJAZZ_HTTP_RETRIES=2
SBERJAZZ_HTTP_RETRY_BACKOFF_MS=300
SBERJAZZ_HTTP_RETRY_STATUSES=408,409,425,429,500,502,503,504
SBERJAZZ_RETRIES=2
SBERJAZZ_RETRY_BACKOFF_MS=300
SBERJAZZ_CB_FAILURE_THRESHOLD=5
SBERJAZZ_CB_OPEN_SEC=60
SBERJAZZ_OP_LOCK_TTL_SEC=60
SBERJAZZ_CB_AUTO_RESET_ENABLED=true
SBERJAZZ_CB_AUTO_RESET_MIN_AGE_SEC=30
SBERJAZZ_SESSION_TTL_SEC=86400
SBERJAZZ_RECONCILE_STALE_SEC=900
SBERJAZZ_LIVE_PULL_ENABLED=true
SBERJAZZ_LIVE_PULL_BATCH_LIMIT=20
SBERJAZZ_LIVE_PULL_SESSIONS_LIMIT=100
SBERJAZZ_LIVE_PULL_RETRIES=1
SBERJAZZ_LIVE_PULL_RETRY_BACKOFF_MS=200
SBERJAZZ_LIVE_PULL_FAIL_RECONNECT_THRESHOLD=3
SBERJAZZ_JOIN_IDEMPOTENT_TTL_SEC=30
SBERJAZZ_REQUIRE_HTTPS_IN_PROD=true
SBERJAZZ_STARTUP_PROBE_ENABLED=true
SBERJAZZ_STARTUP_PROBE_FAIL_FAST_IN_PROD=true
# Для e2e/mock live-pull: base64 одного тестового чанка (пусто = live mock не отправляет чанки)
SBERJAZZ_MOCK_LIVE_CHUNKS_B64=
RECONCILIATION_ENABLED=true
RECONCILIATION_INTERVAL_SEC=60
RECONCILIATION_LIMIT=200

# =============================================================================
# LLM (OpenAI-compatible) — ДЛЯ ОТЧЁТА/АНАЛИТИКИ
# =============================================================================
LLM_ENABLED=false
OPENAI_API_BASE=http://host.docker.internal:11434/v1
OPENAI_API_KEY=
LLM_MODEL_ID=llama3:8b
LLM_TEMPERATURE=0.7

LLM_MAX_TOKENS=2048
LLM_TOP_P=0.95
LLM_FREQUENCY_PENALTY=0.0
LLM_PRESENCE_PENALTY=0.0
LLM_REQUEST_TIMEOUT_SEC=30
LLM_RETRIES=2
LLM_RETRY_BACKOFF_MS=250

# =============================================================================
# DELIVERY / SMTP (если хочешь отправку email)
# =============================================================================
DELIVERY_PROVIDER=email
SMTP_HOST=
SMTP_PORT=587
SMTP_USER=
SMTP_PASS=
EMAIL_FROM=hr-agent@example.com
DELIVERY_MANUAL_MODE_ONLY=true
# format: account_id:from_email,account2:from_email2
DELIVERY_SENDER_ACCOUNTS=
DELIVERY_MAX_RECIPIENTS=20
INTERVIEW_SCENARIOS_DIR=./data/interview_scenarios/examples

# =============================================================================
# QUICK RECORDER (agent2)
# =============================================================================
QUICK_RECORD_OUTPUT_DIR=./recordings
QUICK_RECORD_ENABLED=true
QUICK_RECORD_DEFAULT_DURATION_SEC=1800
QUICK_RECORD_DURATION_SEC=0
QUICK_RECORD_SEGMENT_LENGTH_SEC=120
QUICK_RECORD_OVERLAP_SEC=30
QUICK_RECORD_SAMPLE_RATE=44100
QUICK_RECORD_BLOCK_SIZE=1024
QUICK_RECORD_INPUT_DEVICE=
QUICK_RECORD_MIN_FREE_MB=512
QUICK_RECORD_LANGUAGE=ru
QUICK_RECORD_WHISPER_MODEL_SIZE=
QUICK_RECORD_AUTO_OPEN_URL=false
QUICK_RECORD_AGENT_BASE_URL=http://127.0.0.1:8010
QUICK_RECORD_AGENT_API_KEY=
QUICK_RECORD_AGENT_HTTP_RETRIES=2
QUICK_RECORD_AGENT_HTTP_BACKOFF_SEC=0.75
QUICK_RECORD_BUILD_LOCAL_REPORT=true
QUICK_RECORD_WAIT_REPORT_SEC=180
QUICK_RECORD_POLL_INTERVAL_SEC=3

# =============================================================================
# LOGGING
# =============================================================================
LOG_LEVEL=INFO
# json|text
LOG_FORMAT=json

# =============================================================================
# OTEL TRACING
# =============================================================================
# Включает экспорт trace-спанов (HTTP/WS/queue/workers) в OTLP endpoint.
OTEL_ENABLED=false
# Для docker compose observability-профиля можно оставить значение по умолчанию.
OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318/v1/traces

# =============================================================================
# ALERT RELAY (observability)
# =============================================================================
# В dev/stage можно оставить пустым — relay использует defaults на internal sink.
# В production задай внешние webhook URL (Slack/PagerDuty/incident hub).
ALERT_RELAY_DEFAULT_TARGET_URL=
ALERT_RELAY_WARNING_TARGET_URL=
ALERT_RELAY_CRITICAL_TARGET_URL=
# Shadow-доставка (опционально): дублирует доставку во второй канал.
ALERT_RELAY_DEFAULT_SHADOW_URL=
ALERT_RELAY_WARNING_SHADOW_URL=
ALERT_RELAY_CRITICAL_SHADOW_URL=
ALERT_RELAY_TIMEOUT_SEC=5
ALERT_RELAY_RETRIES=2
ALERT_RELAY_RETRY_BACKOFF_MS=300
ALERT_RELAY_RETRY_STATUSES=408,409,425,429,500,502,503,504
ALERT_RELAY_FAIL_ON_ERROR=true
