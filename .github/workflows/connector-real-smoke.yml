name: Connector Real Smoke

on:
  workflow_dispatch:

concurrency:
  group: connector-real-smoke-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  e2e-real-connector:
    runs-on: ubuntu-latest
    env:
      APP_ENV: dev
      AUTH_MODE: api_key
      API_KEYS: dev-user-key
      SERVICE_API_KEYS: dev-service-key
      STT_PROVIDER: mock
      LLM_ENABLED: "false"
      MEETING_CONNECTOR_PROVIDER: sberjazz
      MEETING_AUTO_JOIN_ON_START: "true"
      E2E_REQUIRE_REPORT: "true"
      E2E_EXPECT_CONNECTOR_PROVIDER: sberjazz
      E2E_CONNECTOR_TIMEOUT_SEC: "240"
      SBERJAZZ_API_BASE: ${{ secrets.SBERJAZZ_API_BASE }}
      SBERJAZZ_API_TOKEN: ${{ secrets.SBERJAZZ_API_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate real connector secrets
        run: |
          test -n "${SBERJAZZ_API_BASE}" || (echo "SBERJAZZ_API_BASE secret is required" && exit 1)
          test -n "${SBERJAZZ_API_TOKEN}" || (echo "SBERJAZZ_API_TOKEN secret is required" && exit 1)

      - name: Real connector e2e smoke
        run: |
          python tools/e2e_connector_live.py \
            --provider sberjazz \
            --require-report

      - name: Compose logs on failure
        if: failure()
        run: docker compose logs --no-color --tail=500 api-gateway worker-stt worker-enhancer worker-analytics worker-delivery worker-reconciliation

      - name: Compose down
        if: always()
        run: docker compose down --remove-orphans
