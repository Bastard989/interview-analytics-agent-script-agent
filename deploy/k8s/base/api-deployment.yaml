apiVersion: apps/v1
kind: Deployment
metadata:
  name: agent-api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: agent-api
  template:
    metadata:
      labels:
        app: agent-api
    spec:
      containers:
        - name: api
          image: ghcr.io/your-org/interview-analytics-agent:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8010
          envFrom:
            - configMapRef:
                name: agent-config
          env:
            - name: SERVICE_NAME
              value: "api-gateway"
            - name: CHUNKS_DIR
              value: "/data/chunks"
            - name: STORAGE_SHARED_FS_DIR
              value: "/data/chunks"
            - name: POSTGRES_DSN_FILE
              value: "/secrets/postgres_dsn"
            - name: REDIS_URL_FILE
              value: "/secrets/redis_url"
            - name: API_KEYS_FILE
              value: "/secrets/api_keys"
            - name: SERVICE_API_KEYS_FILE
              value: "/secrets/service_api_keys"
            - name: JWT_SHARED_SECRET_FILE
              value: "/secrets/jwt_shared_secret"
            - name: SBERJAZZ_API_TOKEN_FILE
              value: "/secrets/sberjazz_api_token"
          volumeMounts:
            - name: shared-data
              mountPath: /data
            - name: agent-secrets
              mountPath: /secrets
              readOnly: true
          readinessProbe:
            httpGet:
              path: /health
              port: 8010
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 2
          livenessProbe:
            httpGet:
              path: /health
              port: 8010
            initialDelaySeconds: 10
            periodSeconds: 20
            timeoutSeconds: 2
          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
            limits:
              cpu: "1"
              memory: "1Gi"
      volumes:
        - name: shared-data
          persistentVolumeClaim:
            claimName: agent-shared-pvc
        - name: agent-secrets
          secret:
            secretName: agent-secrets
